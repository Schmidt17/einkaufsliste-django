{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Einkaufsliste</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'materialize.min.css' %}" type="text/css">
    <link rel="stylesheet" href="{% static 'main.css' %}" type="text/css">

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>
<body>

    <div id="app"></div>

    <script type="text/javascript" src="{% static 'materialize.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'paho_mqtt.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'main.js' %}"></script>

    <script>
        const app = Elm.Main.init({
            node: document.getElementById('app'),
            flags: "{{ api_key }}"
        });

        // to be called when a MQTT message arrives
        function onMessageArrived(message) {
          const msg_string = message.payloadString;
          app.ports.receiveMQTTMessage.send(msg_string);
        }

        // called when the client has connected
        function onConnectSuccess() {
          // Once a connection has been made, subscribe to the needed channels
          client.subscribe(done_topic, {qos: 1});

          // client.subscribe(topic_newItem, {qos: 1});
        }

        // called when the connection process has failed
        function onConnectFailure() {
          connectToBroker(onMessageArrived, onConnectionLost);
        }

        // called when the client loses its connection
        function onConnectionLost(responseObject) {
          connectToBroker(onMessageArrived, onConnectionLost);
        }

        // function to attempt to connect the client to the MQTT broker
        function connectToBroker(newOnMessageArrived, newOnConnectionLost) {
          // set up the user-defined configuration
          client.onMessageArrived = newOnMessageArrived;
          client.onConnectionLost = newOnConnectionLost;

          client.connect({
            onSuccess: onConnectSuccess,
            onFailure: onConnectFailure,
            useSSL: true
          });
        }

        // configuration for the connection to the MQTT broker
        const mqtt_host = "broker.hivemq.com";
        const mqtt_port = 8884;
        const done_topic = "einkaufsliste_doneUpdates";

        // create a MQTT client instance
        const client = new Paho.MQTT.Client(mqtt_host, mqtt_port, "");

        connectToBroker(onMessageArrived, onConnectionLost);


    </script>

</body>
</html>